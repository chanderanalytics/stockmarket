# Feature Documentation for Company Price Features

This document outlines the columns generated by the `3_companies_prices_features.R` script.

## Static Columns

These columns provide the most recent snapshot data for each company.

| Column Name     | Full Name         | Formula/Source            | Meaning                                      |
|-----------------|-------------------|---------------------------|----------------------------------------------|
| `id`            | Company ID        | `companies.id`            | Unique identifier for the company.           |
| `latest_close`  | Latest Close Price| `prices.adj_close` or `prices.close` | The most recent adjusted closing price.      |
| `latest_volume` | Latest Volume     | `prices.volume`           | The trading volume on the most recent day.   |

## Lag-Based Metrics

These metrics are calculated for various lookback periods (lags), denoted by `_Xd` where `X` is the number of trading days (e.g., `_2d`, `_5d`, `_21d`).

### Price Metrics

| Short Name | Full Name                      | Formula                                                               | Meaning                                                                      |
|------------|--------------------------------|-----------------------------------------------------------------------|------------------------------------------------------------------------------|
| `pchg_Xd`  | Price Change (%)               | `100 * (latest_close - close_Xd_ago) / close_Xd_ago`                  | The percentage change in price over the last X trading days.                 |
| `pvol_Xd`  | Price Volatility (%)           | `100 * sd(log(daily_price_returns))` over X days                       | The statistical volatility (standard deviation of log returns) of the price over the period. Higher means more price fluctuation. |
| `phi_Xd`   | Price High                     | `max(prices.high)` over X days                                       | The highest daily price in the last X trading days.                          |
| `plo_Xd`   | Price Low                      | `min(prices.low)` over X days                                        | The lowest daily price in the last X trading days.                           |
| `pdhi_Xd`  | Distance from Price High (%)   | `100 * (latest_close - phi_Xd) / phi_Xd`                               | How far the latest closing price is from the period's high, as a percentage. Negative means below the high. |
| `pdlo_Xd`  | Distance from Price Low (%)    | `100 * (latest_close - plo_Xd) / plo_Xd`                               | How far the latest closing price is from the period's low, as a percentage. Positive means above the low. |

### Volume Metrics (Not calculated for 1d)

| Short Name | Full Name                      | Formula                                                               | Meaning                                                                      |
|------------|--------------------------------|-----------------------------------------------------------------------|------------------------------------------------------------------------------|
| `vchg_Xd`  | Volume Change (%)              | `100 * (latest_volume - volume_Xd_ago) / volume_Xd_ago`               | The percentage change in trading volume over the last X trading days.        |
| `vvol_Xd`  | Volume Volatility (%)          | `100 * sd(log(daily_volume))` over X days                              | The statistical volatility of trading volume. Higher means more erratic volume. |
| `vhi_Xd`   | Volume High                    | `max(volume)` over X days                                             | The highest daily trading volume in the last X trading days.                 |
| `vlo_Xd`   | Volume Low                     | `min(volume)` over X days                                             | The lowest daily trading volume in the last X trading days.                  |
| `vavg_Xd`  | Average Volume                 | `mean(volume)` over X days                                            | The average daily trading volume over the last X trading days.               |
| `vdhi_Xd`  | Distance from Volume High (%)  | `100 * (latest_volume - vhi_Xd) / vhi_Xd`                             | How far the latest volume is from the period's high, as a percentage. Negative means below the high. |
| `vdlo_Xd`  | Distance from Volume Low (%)   | `100 * (latest_volume - vlo_Xd) / vlo_Xd`                             | How far the latest volume is from the period's low, as a percentage. Positive means above the low. | 

### Advanced Price and Volume Metrics (for all lags)

| Short Name | Full Name                      | Formula                                                               | Meaning                                                                      |
|------------|--------------------------------|-----------------------------------------------------------------------|------------------------------------------------------------------------------|
| `atr_Xd`   | Average True Range             | Mean of true range: `TR = max(high - low, abs(high - prev_close), abs(low - prev_close))` over X days | Measures volatility using high, low, and previous close. Higher = more volatile. |
| `var_Xd`   | Value at Risk (5%)             | 5th percentile of log returns over X days                             | The worst 5% daily return over the period; a risk measure.                   |
| `cor_Xd`   | Price-Volume Correlation       | `cor(close, volume)` over X days                                      | Correlation between price and volume over the period.                        |
| `obv_Xd`   | On-Balance Volume Change       | OBV difference over X days: OBV = cumulative sum of volume, adding on up days, subtracting on down days | Measures accumulation/distribution; positive = net buying, negative = net selling. |
| `vwap_Xd`  | Volume Weighted Avg Price      | `sum(close * volume) / sum(volume)` over X days                       | The average price weighted by volume over the period.                        | 

---

### Volume Spike Probability Features

- **Column Example:** `volume_spike_1x_3davg_3`
- **Description:**  
  The probability that the trading volume for a company will exceed a certain multiple of its rolling average volume, within a specified forward period.
- **Components:**
  - `volume_spike`: Indicates this is a volume spike metric.
  - `{N}x`: The spike threshold, as a multiple of the rolling average (e.g., `1x`, `1.5x`, `2x`, `3x`).
  - `{Wdavg}`: The rolling window (in days) used to compute the average volume (e.g., `3davg`, `7davg`, etc.).
  - `{period}`: The forward period (in days) over which the probability is calculated (e.g., `3`, `7`, `10`, `15`, `30`).
- **Calculation:**  
  For each company, for each day, the script checks if the volume in the next `{period}` days exceeds `{N}` times the rolling average volume over the past `{W}` days. The probability is the fraction of such occurrences over the available history.
- **Example:**  
  - `volume_spike_1x_3davg_3` = 0.42 means there is a 42% chance that, in any 3-day period, the volume will exceed 1x the rolling 3-day average.

---

### Price Spike Probability Features

- **Column Example:** `price_spike_2x_7dsd_7`
- **Description:**  
  The probability that the absolute price return over a forward period exceeds a certain multiple of the rolling standard deviation of daily returns.
- **Components:**
  - `price_spike`: Indicates this is a price spike metric.
  - `{N}x`: The spike threshold, as a multiple of the rolling standard deviation (e.g., `1x`, `1.5x`, `2x`, `3x`).
  - `{Wdsd}`: The rolling window (in days) used to compute the standard deviation of daily returns (e.g., `3dsd`, `7dsd`, etc.).
  - `{period}`: The forward period (in days) over which the probability is calculated.
- **Calculation:**  
  For each company, for each day, the script checks if the absolute price return in the next `{period}` days exceeds `{N}` times the rolling standard deviation over the past `{W}` days. The probability is the fraction of such occurrences over the available history.
- **Example:**  
  - `price_spike_2x_7dsd_7` = 0.10 means there is a 10% chance that, in any 7-day period, the price return will exceed 2x the rolling 7-day standard deviation.

---

### General Notes

- All probabilities are calculated over the available historical data for each company.
- These features are useful for identifying stocks with a high likelihood of experiencing significant price or volume moves, which can be valuable for swing trading strategies. 